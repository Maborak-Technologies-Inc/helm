apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "chart-name" . }}-server
spec:
  replicas: {{ .Values.replicas.zabbixServer }}
  selector:
    matchLabels:
      app: {{ include "chart-name" . }}-server
  template:
    metadata:
      labels:
        app: {{ include "chart-name" . }}-server
      {{- if .Values.images.zabbixServer.buildDate }}
      annotations:
        image.buildDate: {{ .Values.images.zabbixServer.buildDate | quote }}
        {{- $tag := .Values.images.zabbixServer.tag | default .Chart.AppVersion }}
        image: {{ printf "%s:%s" .Values.images.zabbixServer.repository $tag | quote }}
      {{- end }}
    spec:
      serviceAccountName: {{ include "chart-name" . }}-kubectl-executor  # Use Helm templating for SA
      volumes:
        - name: zabbix-config
          emptyDir: {}
        - name: config-volume
          configMap:
            name: {{ include "chart-name" . }}-config
        - name: secret-volume
          secret:
            secretName: {{ include "chart-name" . }}-db-secret
      initContainers:
        - name: init-config
          image: alpine:latest
          env:
            - name: POD_NAME
              valueFrom:
                fieldRef:
                  fieldPath: metadata.name
          command: ["/bin/sh", "-c"]
          args:
            - |
              cp /config/zabbix_server.conf /tmp/zabbix_server.conf
              sed -i "s/DBHost=.*/DBHost={{ include "zabbix-mariadb-chart.dbServer" . }}/g" /tmp/zabbix_server.conf
              sed -i "s/DBPassword=\${MARIADB_PASSWORD}/DBPassword=$(cat /secrets/MARIADB_PASSWORD)/g" /tmp/zabbix_server.conf
              echo "HANodeName=$POD_NAME" >> /tmp/zabbix_server.conf
              cat /tmp/zabbix_server.conf
          volumeMounts:
            - name: config-volume
              mountPath: /config
            - name: zabbix-config
              mountPath: /tmp
            - name: secret-volume
              mountPath: /secrets
              readOnly: true
      containers:
        - name: {{ include "chart-name" . }}-zabbix-server
          image: "{{ .Values.images.zabbixServer.repository }}:{{ default .Chart.AppVersion .Values.images.zabbixServer.tag }}"
          imagePullPolicy: {{ .Values.images.zabbixServer.pullPolicy }}
          env:
            - name: MARIADB_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: {{ include "chart-name" . }}-db-secret
                  key: MARIADB_PASSWORD
          resources:
            limits:
              memory: {{ .Values.resources.zabbixServer.limits.memory }}
              cpu: {{ .Values.resources.zabbixServer.limits.cpu }}
            requests:
              memory: {{ .Values.resources.zabbixServer.requests.memory }}
              cpu: {{ .Values.resources.zabbixServer.requests.cpu }}
          volumeMounts:
            - name: zabbix-config
              mountPath: /var/lib/zabbix/etc/zabbix_server.conf
              subPath: zabbix_server.conf
        - name: label-updater  # Sidecar container
          image: bitnami/kubectl  # Lightweight Kubernetes CLI image
          command: ["/bin/sh", "-c"]
          args:
            - |
              POD_NAME=$(hostname)
              NAMESPACE=$(cat /var/run/secrets/kubernetes.io/serviceaccount/namespace)
              CONTAINER_NAME="{{ include "chart-name" . }}-zabbix-server"
              APP_LABEL="{{ include "chart-name" . }}-server"

              # Ensure pod has a label before modifying it
              if ! kubectl get pod $POD_NAME -n $NAMESPACE -o jsonpath='{.metadata.labels.mode}' 2>/dev/null; then
                  echo "Initializing label: mode=standby"
                  kubectl label pod $POD_NAME -n $NAMESPACE mode=standby --overwrite
              fi

              LOG_FILE="/var/lib/zabbix/log/zabbix-server.log"

              # Wait for server to start and log file to be available
              echo "Waiting for Zabbix server to be ready..."
              for i in $(seq 1 60); do
                  if kubectl exec $POD_NAME -n $NAMESPACE -c $CONTAINER_NAME -- test -f "$LOG_FILE" 2>/dev/null; then
                      echo "Server log file found, starting label monitoring..."
                      break
                  fi
                  sleep 2
              done

              while true; do
                  CURRENT_MODE=$(kubectl get pod $POD_NAME -n $NAMESPACE -o jsonpath='{.metadata.labels.mode}' 2>/dev/null || echo "standby")
                  
                  # Read the actual Zabbix server log file to check HA mode
                  # Look for the most recent mode message (active or standby)
                  HA_MODE=$(kubectl exec $POD_NAME -n $NAMESPACE -c $CONTAINER_NAME -- tail -500 "$LOG_FILE" 2>/dev/null | grep -iE 'node.*(active|standby).*mode|node.*working in.*(active|standby).*mode|node.*switched to.*(active|standby).*mode' | tail -1)
                  
                  # Determine if this pod is actually active or standby based on log
                  if echo "$HA_MODE" | grep -qiE 'node.*active.*mode|node.*working in.*active.*mode|node.*switched to.*active.*mode|node.*started in.*active.*mode'; then
                      # Log shows this pod is in active mode
                      if [ "$CURRENT_MODE" != "active" ]; then
                          echo "Setting $POD_NAME to active mode (detected from log: $HA_MODE)."
                          kubectl label pod $POD_NAME -n $NAMESPACE mode=active --overwrite
                      fi
                  elif echo "$HA_MODE" | grep -qiE 'node.*standby.*mode|node.*working in.*standby.*mode'; then
                      # Log shows this pod is in standby mode
                      if [ "$CURRENT_MODE" != "standby" ]; then
                          echo "Setting $POD_NAME to standby mode (detected from log: $HA_MODE)."
                          kubectl label pod $POD_NAME -n $NAMESPACE mode=standby --overwrite
                      fi
                  else
                      # No clear mode message in log yet, use fallback logic
                      # Check if there are other pods with active labels (same app label only)
                      OTHER_ACTIVE=$(kubectl get pods -n $NAMESPACE -l app=$APP_LABEL,mode=active --field-selector metadata.name!=$POD_NAME --no-headers 2>/dev/null | wc -l)
                      
                      if [ "$OTHER_ACTIVE" -eq 0 ]; then
                          # No other active servers, default to active (single-node scenario)
                          if [ "$CURRENT_MODE" != "active" ]; then
                              echo "Setting $POD_NAME to active mode (no other active servers found, fallback)."
                              kubectl label pod $POD_NAME -n $NAMESPACE mode=active --overwrite
                          fi
                      else
                          # Other active servers exist, default to standby
                          if [ "$CURRENT_MODE" != "standby" ]; then
                              echo "Setting $POD_NAME to standby mode (other active servers exist, fallback)."
                              kubectl label pod $POD_NAME -n $NAMESPACE mode=standby --overwrite
                          fi
                      fi
                  fi

                  sleep 10
              done
