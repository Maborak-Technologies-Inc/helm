{{- if .Values.ui.enabled }}
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "amazon-watcher-stack.fullname" . }}-ui
  labels:
    {{- include "amazon-watcher-stack.labels" . | nindent 4 }}
    app.kubernetes.io/component: ui
  {{- if .Values.argocd.annotations }}
  annotations:
    {{- include "amazon-watcher-stack.argocd.annotations" . | nindent 4 }}
  {{- end }}
spec:
  replicas: {{ .Values.ui.replicas }}
  selector:
    matchLabels:
      {{- include "amazon-watcher-stack.selectorLabels" . | nindent 6 }}
      app.kubernetes.io/component: ui
  template:
    metadata:
      labels:
        {{- include "amazon-watcher-stack.selectorLabels" . | nindent 8 }}
        app.kubernetes.io/component: ui
      annotations:
        checksum/env: {{ include "amazon-watcher-stack.ui.envChecksum" . }}
        {{- with .Values.podAnnotations }}
        {{- toYaml . | nindent 8 }}
        {{- end }}
    spec:
      # UI (nginx) needs to create cache directories
      # Use less restrictive security context
      securityContext:
        fsGroup: 101
      {{- if .Values.serviceAccount.create }}
      serviceAccountName: {{ include "amazon-watcher-stack.fullname" . }}
      {{- end }}
      # Init container to create nginx cache directories with proper permissions
      initContainers:
        - name: init-nginx-cache
          image: alpine:latest
          command: ['sh', '-c']
          args:
            - |
              mkdir -p /var/cache/nginx/client_temp
              mkdir -p /var/cache/nginx/proxy_temp
              mkdir -p /var/cache/nginx/fastcgi_temp
              mkdir -p /var/cache/nginx/uwsgi_temp
              mkdir -p /var/cache/nginx/scgi_temp
              chown -R 101:101 /var/cache/nginx
          securityContext:
            runAsUser: 0
          volumeMounts:
            - name: nginx-cache
              mountPath: /var/cache/nginx
      containers:
        - name: ui
          image: {{ include "amazon-watcher-stack.ui.image" . }}
          imagePullPolicy: {{ .Values.ui.image.pullPolicy }}
          env:
            # Computed VITE_API_BASE_URL (use from env if set, otherwise use domain)
            - name: VITE_API_BASE_URL
              value: {{ .Values.ui.env.VITE_API_BASE_URL | default (printf "//%s" .Values.global.domain.backend) | quote }}
            # Iterate over all env vars from values.yaml
            {{- include "amazon-watcher-stack.ui.env" . | nindent 12 }}
          ports:
            - name: http
              containerPort: 80
              protocol: TCP
          {{- if .Values.ui.healthCheck.enabled }}
          livenessProbe:
            httpGet:
              path: {{ .Values.ui.healthCheck.path }}
              port: 80
            initialDelaySeconds: {{ .Values.ui.healthCheck.initialDelaySeconds }}
            periodSeconds: {{ .Values.ui.healthCheck.periodSeconds }}
            timeoutSeconds: {{ .Values.ui.healthCheck.timeoutSeconds }}
            failureThreshold: {{ .Values.ui.healthCheck.failureThreshold }}
          readinessProbe:
            httpGet:
              path: {{ .Values.ui.healthCheck.path }}
              port: 80
            initialDelaySeconds: {{ .Values.ui.healthCheck.initialDelaySeconds }}
            periodSeconds: {{ .Values.ui.healthCheck.periodSeconds }}
            timeoutSeconds: {{ .Values.ui.healthCheck.timeoutSeconds }}
            failureThreshold: {{ .Values.ui.healthCheck.failureThreshold }}
          {{- end }}
          resources:
            {{- toYaml .Values.ui.resources | nindent 12 }}
          volumeMounts:
            - name: nginx-cache
              mountPath: /var/cache/nginx
          # nginx runs as root (UID 0) to match docker-compose behavior
          # In docker-compose, containers run as root by default, allowing binding to port 80
          securityContext:
            runAsUser: 0
            runAsGroup: 0
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: false
      volumes:
        - name: nginx-cache
          emptyDir: {}
      {{- with .Values.nodeSelector }}
      nodeSelector:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with .Values.affinity }}
      affinity:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with .Values.tolerations }}
      tolerations:
        {{- toYaml . | nindent 8 }}
      {{- end }}
{{- end }}
