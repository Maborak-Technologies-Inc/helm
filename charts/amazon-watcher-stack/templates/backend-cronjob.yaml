{{- if .Values.backend.cronjob.enabled }}
{{- /* Validation: If database is disabled, APT_BACKEND_DATABASE_URL must be set */}}
{{- if and (not .Values.database.enabled) (not .Values.backend.env.APT_BACKEND_DATABASE_URL) }}
{{- fail "ERROR: database.enabled=false but APT_BACKEND_DATABASE_URL is empty. You must provide an external database URL when the internal database is disabled." }}
{{- end }}
apiVersion: batch/v1
kind: CronJob
metadata:
  name: {{ include "amazon-watcher-stack.fullname" . }}-backend-cronjob
  labels:
    {{- include "amazon-watcher-stack.labels" . | nindent 4 }}
    app.kubernetes.io/component: backend-cronjob
  {{- if .Values.argocd.annotations }}
  annotations:
    {{- include "amazon-watcher-stack.argocd.annotations" . | nindent 4 }}
  {{- end }}
spec:
  schedule: {{ .Values.backend.cronjob.schedule | quote }}
  {{- if .Values.backend.cronjob.concurrencyPolicy }}
  concurrencyPolicy: {{ .Values.backend.cronjob.concurrencyPolicy }}
  {{- end }}
  {{- if .Values.backend.cronjob.successfulJobsHistoryLimit }}
  successfulJobsHistoryLimit: {{ .Values.backend.cronjob.successfulJobsHistoryLimit }}
  {{- end }}
  {{- if .Values.backend.cronjob.failedJobsHistoryLimit }}
  failedJobsHistoryLimit: {{ .Values.backend.cronjob.failedJobsHistoryLimit }}
  {{- end }}
  {{- if .Values.backend.cronjob.suspend }}
  suspend: {{ .Values.backend.cronjob.suspend }}
  {{- end }}
  jobTemplate:
    spec:
      {{- if .Values.backend.cronjob.backoffLimit }}
      backoffLimit: {{ .Values.backend.cronjob.backoffLimit }}
      {{- end }}
      {{- if .Values.backend.cronjob.activeDeadlineSeconds }}
      activeDeadlineSeconds: {{ .Values.backend.cronjob.activeDeadlineSeconds }}
      {{- end }}
      template:
        metadata:
          labels:
            {{- include "amazon-watcher-stack.selectorLabels" . | nindent 12 }}
            app.kubernetes.io/component: backend-cronjob
          annotations:
            checksum/env: {{ include "amazon-watcher-stack.backend.envChecksum" . }}
            {{- with .Values.podAnnotations }}
            {{- toYaml . | nindent 12 }}
            {{- end }}
        spec:
          {{- with .Values.podSecurityContext }}
          securityContext:
            {{- toYaml . | nindent 12 }}
          {{- end }}
          {{- if .Values.serviceAccount.create }}
          serviceAccountName: {{ include "amazon-watcher-stack.fullname" . }}
          {{- end }}
          {{- if .Values.backend.cronjob.waitForBackend }}
          initContainers:
          - name: wait-for-backend
            image: curlimages/curl:latest
            command: ['sh', '-c']
            args:
              - |
                echo "Waiting for backend service to be ready..."
                BACKEND_SERVICE="{{ include "amazon-watcher-stack.backend.serviceName" . }}"
                BACKEND_PORT="{{ .Values.backend.env.APT_BACKEND_UVI_PORT | default "9000" | int }}"
                MAX_WAIT={{ .Values.backend.cronjob.maxWaitSeconds | default 300 }}
                ELAPSED=0
                
                # Wait for backend service
                echo "Checking backend service: $BACKEND_SERVICE:$BACKEND_PORT"
                until curl -f -s --max-time 2 http://$BACKEND_SERVICE:$BACKEND_PORT/health >/dev/null 2>&1; do
                  if [ $ELAPSED -ge $MAX_WAIT ]; then
                    echo "❌ Timeout: Backend service not available after ${MAX_WAIT}s"
                    exit 1
                  fi
                  echo "Waiting for $BACKEND_SERVICE:$BACKEND_PORT... (${ELAPSED}s/${MAX_WAIT}s)"
                  sleep 5
                  ELAPSED=$((ELAPSED + 5))
                done
                echo "✅ Backend service is ready at $BACKEND_SERVICE:$BACKEND_PORT"
          {{- end }}
          containers:
          - name: backend-cronjob
            image: {{ include "amazon-watcher-stack.backend.image" . }}
            imagePullPolicy: {{ .Values.backend.image.pullPolicy }}
            workingDir: /app
            command: ["/bin/sh", "-c"]
            args:
              - |
                set -e
                echo "Starting backend cronjob command..."
                echo "Command: {{ .Values.backend.cronjob.command }}"
                echo "---"
                {{ .Values.backend.cronjob.command }}
                echo "---"
                echo "Command completed successfully"
            env:
              - name: PYTHONPATH
                value: "/app"
              # Special env vars (from secrets or computed) - same as backend rollout
              {{- if .Values.database.enabled }}
              - name: POSTGRES_PASSWORD
                valueFrom:
                  secretKeyRef:
                    name: {{ include "amazon-watcher-stack.fullname" . }}-db-secret
                    key: postgres-password
              {{- end }}
              - name: APT_BACKEND_JWT_SECRET
                valueFrom:
                  secretKeyRef:
                    name: {{ include "amazon-watcher-stack.fullname" . }}-backend-secret
                    key: jwt-secret
              # Computed DATABASE_URL (use from env if set, otherwise auto-generate)
              - name: APT_BACKEND_DATABASE_URL
                value: {{ .Values.backend.env.APT_BACKEND_DATABASE_URL | default (include "amazon-watcher-stack.db.url" .) | quote }}
              # Computed SCREENSHOT_SERVICE_URL (use from env if set, otherwise auto-generate)
              - name: APT_BACKEND_SCREENSHOT_SERVICE_URL
                value: {{ .Values.backend.env.APT_BACKEND_SCREENSHOT_SERVICE_URL | default (printf "http://%s.%s.svc.cluster.local:%d/amazon/" (include "amazon-watcher-stack.screenshot.serviceName" .) (.Release.Namespace | default "default") (.Values.screenshot.env.APT_BROWSER_PORT | default "3000" | int)) | quote }}
              # Computed DOMAIN_UI (use from env if set, otherwise auto-generate from global.domain.ui)
              - name: DOMAIN_UI
                {{- if .Values.backend.env.DOMAIN_UI }}
                value: {{ .Values.backend.env.DOMAIN_UI | quote }}
                {{- else if .Values.global.domain.ui }}
                value: {{ printf "http://%s" .Values.global.domain.ui | quote }}
                {{- else }}
                value: ""
                {{- end }}
              # Iterate over all env vars from values.yaml - same as backend rollout
              {{- include "amazon-watcher-stack.backend.env" . | nindent 14 }}
            resources:
              {{- toYaml .Values.backend.cronjob.resources | nindent 14 }}
            {{- with .Values.securityContext }}
            securityContext:
              {{- toYaml . | nindent 14 }}
            {{- end }}
          restartPolicy: OnFailure
{{- end }}
