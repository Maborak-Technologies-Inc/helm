{{- if .Values.backend.cli.enabled }}
{{- /* Validation: If database is disabled, APT_BACKEND_DATABASE_URL must be set */}}
{{- if and (not .Values.database.enabled) (not .Values.backend.env.APT_BACKEND_DATABASE_URL) }}
{{- fail "ERROR: database.enabled=false but APT_BACKEND_DATABASE_URL is empty. You must provide an external database URL when the internal database is disabled." }}
{{- end }}
apiVersion: argoproj.io/v1alpha1
kind: Rollout
metadata:
  name: {{ include "amazon-watcher-stack.fullname" . }}-backend-cli
  labels:
    {{- include "amazon-watcher-stack.labels" . | nindent 4 }}
    app.kubernetes.io/component: backend-cli
  {{- if .Values.argocd.annotations }}
  annotations:
    {{- include "amazon-watcher-stack.argocd.annotations" . | nindent 4 }}
  {{- end }}
spec:
  {{- $hpaEnabled := false }}
  {{- if and (hasKey .Values.backend.cli "autoscaling") .Values.backend.cli.autoscaling.enabled }}
    {{- $hpaEnabled = .Values.backend.cli.autoscaling.enabled }}
  {{- end }}
  {{- if and (hasKey .Values.global "hpa") (ne .Values.global.hpa nil) (ne .Values.global.hpa "") }}
    {{- $hpaEnabled = .Values.global.hpa }}
  {{- end }}
  {{- if not $hpaEnabled }}
  # Only set replicas if HPA is not enabled (HPA will manage replicas when enabled)
  replicas: {{ .Values.backend.cli.replicas }}
  {{- else if and (hasKey .Values.backend.cli "autoscaling") .Values.backend.cli.autoscaling.minReplicas }}
  # When HPA is enabled, set initial replicas to minReplicas (HPA will manage scaling)
  replicas: {{ .Values.backend.cli.autoscaling.minReplicas }}
  {{- end }}
  revisionHistoryLimit: {{ if hasKey .Values.backend.cli "rollout" }}{{ .Values.backend.cli.rollout.revisionHistoryLimit | default 10 }}{{ else }}10{{ end }}
  {{- if and (hasKey .Values.backend.cli "rollout") .Values.backend.cli.rollout.progressDeadlineSeconds }}
  progressDeadlineSeconds: {{ .Values.backend.cli.rollout.progressDeadlineSeconds }}
  {{- end }}
  selector:
    matchLabels:
      {{- include "amazon-watcher-stack.selectorLabels" . | nindent 6 }}
      app.kubernetes.io/component: backend-cli
  template:
    metadata:
      labels:
        {{- include "amazon-watcher-stack.selectorLabels" . | nindent 8 }}
        app.kubernetes.io/component: backend-cli
      annotations:
        checksum/env: {{ include "amazon-watcher-stack.backend.envChecksum" . }}
        {{- with .Values.podAnnotations }}
        {{- toYaml . | nindent 8 }}
        {{- end }}
    spec:
      {{- with .Values.podSecurityContext }}
      securityContext:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- if .Values.serviceAccount.create }}
      serviceAccountName: {{ include "amazon-watcher-stack.fullname" . }}
      {{- end }}
      {{- if .Values.backend.cli.waitForBackend }}
      initContainers:
      - name: wait-for-services
        image: curlimages/curl:latest
        command: ['sh', '-c']
        args:
          - |
            echo "Waiting for backend and screenshot services to be ready..."
            BACKEND_SERVICE="{{ include "amazon-watcher-stack.backend.serviceName" . }}"
            BACKEND_PORT="{{ .Values.backend.env.APT_BACKEND_UVI_PORT | default "9000" | int }}"
            SCREENSHOT_SERVICE="{{ include "amazon-watcher-stack.screenshot.serviceName" . }}"
            SCREENSHOT_PORT="{{ .Values.screenshot.env.APT_BROWSER_PORT | default "3000" | int }}"
            MAX_WAIT={{ .Values.backend.cli.maxWaitSeconds | default 300 }}
            ELAPSED=0
            
            # Wait for backend service
            echo "Checking backend service: $BACKEND_SERVICE:$BACKEND_PORT"
            until curl -f -s --max-time 2 http://$BACKEND_SERVICE:$BACKEND_PORT/health >/dev/null 2>&1; do
              if [ $ELAPSED -ge $MAX_WAIT ]; then
                echo "❌ Timeout: Backend service not available after ${MAX_WAIT}s"
                exit 1
              fi
              echo "Waiting for $BACKEND_SERVICE:$BACKEND_PORT... (${ELAPSED}s/${MAX_WAIT}s)"
              sleep 5
              ELAPSED=$((ELAPSED + 5))
            done
            echo "✅ Backend service is ready at $BACKEND_SERVICE:$BACKEND_PORT"
            
            # Reset elapsed for screenshot check
            ELAPSED=0
            
            # Wait for screenshot service
            echo "Checking screenshot service: $SCREENSHOT_SERVICE:$SCREENSHOT_PORT"
            until curl -f -s --max-time 2 http://$SCREENSHOT_SERVICE:$SCREENSHOT_PORT/health >/dev/null 2>&1; do
              if [ $ELAPSED -ge $MAX_WAIT ]; then
                echo "❌ Timeout: Screenshot service not available after ${MAX_WAIT}s"
                exit 1
              fi
              echo "Waiting for $SCREENSHOT_SERVICE:$SCREENSHOT_PORT... (${ELAPSED}s/${MAX_WAIT}s)"
              sleep 5
              ELAPSED=$((ELAPSED + 5))
            done
            echo "✅ Screenshot service is ready at $SCREENSHOT_SERVICE:$SCREENSHOT_PORT"
            echo "✅ All required services are ready!"
      {{- end }}
      containers:
      - name: backend-cli
        image: {{ include "amazon-watcher-stack.backend.image" . }}
        imagePullPolicy: {{ .Values.backend.image.pullPolicy }}
        workingDir: /app
        command: ["/bin/sh", "-c"]
        args:
          - |
            set -e
            echo "Starting backend CLI command..."
            echo "Command: {{ .Values.backend.cli.command }}"
            echo "---"
            {{ .Values.backend.cli.command }}
        env:
          - name: PYTHONPATH
            value: "/app"
          # Special env vars (from secrets or computed) - same as backend rollout
          {{- if .Values.database.enabled }}
          - name: POSTGRES_PASSWORD
            valueFrom:
              secretKeyRef:
                name: {{ include "amazon-watcher-stack.fullname" . }}-db-secret
                key: postgres-password
          {{- end }}
          - name: APT_BACKEND_JWT_SECRET
            valueFrom:
              secretKeyRef:
                name: {{ include "amazon-watcher-stack.fullname" . }}-backend-secret
                key: jwt-secret
          # Computed DATABASE_URL (use from env if set, otherwise auto-generate)
          - name: APT_BACKEND_DATABASE_URL
            value: {{ .Values.backend.env.APT_BACKEND_DATABASE_URL | default (include "amazon-watcher-stack.db.url" .) | quote }}
          # Computed SCREENSHOT_SERVICE_URL (use from env if set, otherwise auto-generate)
          - name: APT_BACKEND_SCREENSHOT_SERVICE_URL
            value: {{ .Values.backend.env.APT_BACKEND_SCREENSHOT_SERVICE_URL | default (printf "http://%s.%s.svc.cluster.local:%d/amazon/" (include "amazon-watcher-stack.screenshot.serviceName" .) (.Release.Namespace | default "default") (.Values.screenshot.env.APT_BROWSER_PORT | default "3000" | int)) | quote }}
          # Computed DOMAIN_UI (use from env if set, otherwise auto-generate from global.domain.ui)
          - name: DOMAIN_UI
            {{- if .Values.backend.env.DOMAIN_UI }}
            value: {{ .Values.backend.env.DOMAIN_UI | quote }}
            {{- else if .Values.global.domain.ui }}
            value: {{ printf "http://%s" .Values.global.domain.ui | quote }}
            {{- else }}
            value: ""
            {{- end }}
          # Iterate over all env vars from values.yaml - same as backend rollout
          {{- include "amazon-watcher-stack.backend.env" . | nindent 10 }}
        {{- if .Values.global.storage.enabled }}
        volumeMounts:
          - name: cli-storage
            mountPath: {{ if and (hasKey .Values.backend.cli "storage") (hasKey .Values.backend.cli.storage "mountPath") }}{{ .Values.backend.cli.storage.mountPath }}{{ else }}/var/screenshots{{ end }}
        {{- end }}
        resources:
          {{- toYaml .Values.backend.resources | nindent 10 }}
        {{- with .Values.securityContext }}
        securityContext:
          {{- toYaml . | nindent 10 }}
        {{- end }}
      {{- if .Values.global.storage.enabled }}
      volumes:
        - name: cli-storage
          persistentVolumeClaim:
            claimName: {{ include "amazon-watcher-stack.fullname" . }}-storage
      {{- end }}
      {{- with .Values.nodeSelector }}
      nodeSelector:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with .Values.affinity }}
      affinity:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with .Values.tolerations }}
      tolerations:
        {{- toYaml . | nindent 8 }}
      {{- end }}
  {{- if and (hasKey .Values.backend.cli "rollout") .Values.backend.cli.rollout.strategy }}
  strategy:
    {{- toYaml .Values.backend.cli.rollout.strategy | nindent 4 }}
  {{- else }}
  # Default to simple canary strategy (equivalent to rolling update)
  strategy:
    canary:
      steps: []
  {{- end }}
{{- end }}
